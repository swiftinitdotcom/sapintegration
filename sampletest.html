<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MSAL SPA User Details</title>
    <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js"></script>
    <style>
        table { border-collapse: collapse; width: 100%; max-width: 800px; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
    </style>
</head>
<body>
    <h1>MSAL SPA User Details Demo</h1>
    <button id="loginBtn">Login</button>
    <button id="getUserBtn">Get User Details</button>
    <pre id="output"></pre>
    <div id="userDetails"></div>

    <script>
        // MSAL configuration
		console.log(window.location.origin + window.location.pathname);
        const msalConfig = {
            auth: {
                clientId: "31a89c6a-bac7-46ea-b4cc-ddf5ef9669f2",
                authority: "https://login.microsoftonline.com/47ef8c81-9426-489b-b594-29d779d74829",
                redirectUri: window.location.origin + window.location.pathname
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // User fields to display
        const fields = [
            { key: 'id', label: 'ID' },
            { key: 'displayName', label: 'Display Name' },
            { key: 'givenName', label: 'Given Name' },
            { key: 'surname', label: 'Surname' },
            { key: 'mail', label: 'Email' },
            { key: 'businessPhones', label: 'Business Phone', format: phones => phones.join(', ') },
            { key: 'mobilePhone', label: 'Mobile Phone' },
            { key: 'jobTitle', label: 'Job Title' },
            { key: 'officeLocation', label: 'Office Location' },
            { key: 'preferredLanguage', label: 'Preferred Language' },
            { key: 'userPrincipalName', label: 'User Principal Name' }
        ];

        // Login function
        async function login() {
            try {
                const loginResponse = await msalInstance.loginPopup({ scopes: ["User.Read"] });
                msalInstance.setActiveAccount(loginResponse.account);
                document.getElementById("output").textContent = `Logged in as: ${loginResponse.account.username}`;
            } catch (error) {
                console.error(error);
                document.getElementById("output").textContent = `Login error: ${error}`;
            }
        }

        // Acquire token silently
        async function getToken() {
            const account = msalInstance.getActiveAccount();
            if (!account) throw new Error("No active account! Please login first.");

            try {
                const tokenResponse = await msalInstance.acquireTokenSilent({
                    account: account,
                    scopes: ["User.Read"]
                });
                return tokenResponse.accessToken;
            } catch (error) {
                console.warn("Silent token acquisition failed, trying popup...", error);
                const tokenResponse = await msalInstance.acquireTokenPopup({ scopes: ["User.Read"] });
                msalInstance.setActiveAccount(tokenResponse.account);
                return tokenResponse.accessToken;
            }
        }

        // Fetch user details from Microsoft Graph
        async function getUserDetails() {
            try {
                const token = await getToken();
                const response = await fetch('https://graph.microsoft.com/v1.0/me', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const user = await response.json();

                // Build HTML table
                let html = '<table><tr><th>Field</th><th>Value</th></tr>';
                fields.forEach(f => {
                    let value = user[f.key];
                    if (value === undefined || value === null) value = '';
                    if (f.format) value = f.format(value);
                    html += `<tr><td>${f.label}</td><td>${value}</td></tr>`;
                });
                html += '</table>';
                document.getElementById('userDetails').innerHTML = html;
            } catch (error) {
                console.error(error);
                document.getElementById('output').textContent = `Error fetching user: ${error}`;
            }
        }

        // Event listeners
        document.getElementById("loginBtn").addEventListener("click", login);
        document.getElementById("getUserBtn").addEventListener("click", getUserDetails);

        // Check if already logged in
        const currentAccount = msalInstance.getActiveAccount();
        if (currentAccount) {
            document.getElementById("output").textContent = `Already logged in as: ${currentAccount.username}`;
        }
    </script>
</body>
</html>
